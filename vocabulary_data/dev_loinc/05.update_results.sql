SET ECHO OFF
SET TERMOUT ON
SET LINESIZE 3000
SET PAGESIZE 45
SET SERVEROUTPUT ON
SET VERIFY OFF
/* If any errors occurs - stop script execution and return error code */
WHENEVER SQLERROR EXIT SQL.SQLCODE
/*
 *****************************
 *  Log to file...    
 *****************************
*/
SPOOL '&1'

/**
* Perform update results verification
**/
PROMPT ***
PROMPT * Verification of update results...
PROMPT ***

-- Define column width
COLUMN CHECK_ID FORMAT A8 HEADING 'CHECK_ID' NULL - WRAP
COLUMN CONCEPT_ID_1 FORMAT A12 HEADING 'CONCEPT_ID_1' NULL - WRAP
COLUMN CONCEPT_ID_2 FORMAT A12 HEADING 'CONCEPT_ID_2' NULL - WRAP
COLUMN RELATIONSHIP_ID FORMAT A20 HEADING 'RELATIONSHIP_ID' NULL - WRAP
COLUMN VALID_START_DATE FORMAT A18 HEADING 'VALID_START_DATE' NULL - WRAP
COLUMN VALID_END_DATE FORMAT A18 HEADING 'VALID_END_DATE' NULL - WRAP
COLUMN INVALID_REASON FORMAT A15 HEADING 'INVALID_REASON' NULL - WRAP

-- Perform common checks
PROMPT Perform common "get checks"...
SELECT
	TO_CHAR(CHECK_ID) as CHECK_ID,
	TO_CHAR(CONCEPT_ID_1) as CONCEPT_ID_1,
	TO_CHAR(CONCEPT_ID_2) as CONCEPT_ID_2,
	RELATIONSHIP_ID,
	TO_CHAR(VALID_START_DATE, 'DD-MON-YYYY') AS VALID_START_DATE,
	TO_CHAR(VALID_END_DATE, 'DD-MON-YYYY') AS VALID_END_DATE,
	INVALID_REASON
FROM TABLE(DEVV5.QA_TESTS.GET_CHECKS);

-- Define column width
COLUMN VOCABULARY_ID FORMAT A18 HEADING 'VOCABULARY_ID' NULL - WRAP
COLUMN CONCEPT_CLASS_ID FORMAT A30 HEADING 'CONCEPT_CLASS_ID' NULL - WRAP
COLUMN INVALID_REASON FORMAT A15 HEADING 'INVALID_REASON' NULL - WRAP
COLUMN CONCEPT_DELTA FORMAT A15 HEADING 'CONCEPT_DELTA' NULL - WRAP

-- Clear cache
PROMPT Clear cache...
EXEC DEVV5.QA_TESTS.PURGE_CACHE;

-- Perform CONCEPT checks
PROMPT Perform "get summary" for CONCEPT...
WITH VGSC AS (SELECT * FROM TABLE(DEVV5.QA_TESTS.get_summary('concept'))
              ORDER BY ABS(CONCEPT_DELTA) DESC, VOCABULARY_ID_1, CONCEPT_CLASS_ID, INVALID_REASON)
SELECT VOCABULARY_ID_1 AS VOCABULARY_ID,
       CONCEPT_CLASS_ID,
       INVALID_REASON,
       TO_CHAR(CAST(CONCEPT_DELTA AS FLOAT)) AS CONCEPT_DELTA
FROM VGSC
  UNION ALL
SELECT '-',
       '-',
       '-',
       TO_CHAR(SUM(CONCEPT_DELTA))
FROM VGSC;

-- Define column width
COLUMN VOCABULARY_ID_1 FORMAT A18 HEADING 'VOCABULARY_ID_1' NULL - WRAP
COLUMN RELATIONSHIP_ID FORMAT A30 HEADING 'RELATIONSHIP_ID' NULL - WRAP
COLUMN VOCABULARY_ID_2 FORMAT A18 HEADING 'VOCABULARY_ID_2' NULL - WRAP
COLUMN INVALID_REASON FORMAT A15 HEADING 'INVALID_REASON' NULL - WRAP
COLUMN CONCEPT_DELTA FORMAT A15 HEADING 'CONCEPT_DELTA' NULL - WRAP

-- Perform CONCEPT RELATIONSHIPS checks
PROMPT Perform "get summary" for CONCEPT_RELATIONSHIP...
WITH VGSCR AS (SELECT * FROM TABLE(DEVV5.QA_TESTS.get_summary('concept_relationship'))
               ORDER BY ABS(CONCEPT_DELTA) DESC, VOCABULARY_ID_1, RELATIONSHIP_ID, VOCABULARY_ID_2, INVALID_REASON)
SELECT VOCABULARY_ID_1,
       RELATIONSHIP_ID,
       VOCABULARY_ID_2,
       INVALID_REASON,
       TO_CHAR(CAST(CONCEPT_DELTA AS FLOAT)) AS CONCEPT_DELTA
FROM VGSCR
  UNION ALL
SELECT '-',
       '-',
       '-',
       '-',
       TO_CHAR(SUM(CONCEPT_DELTA))
FROM VGSCR;

-- Define column width
COLUMN VOCABULARY_ID FORMAT A18 HEADING 'VOCABULARY_ID' NULL - WRAP
COLUMN CONCEPT_DELTA FORMAT A15 HEADING 'CONCEPT_DELTA' NULL - WRAP

-- Perform CONCEPT ANCESTOR checks
PROMPT Perform "get summary" for CONCEPT ANCESTOR...
WITH VGSC AS (SELECT * FROM TABLE(DEVV5.QA_TESTS.get_summary('concept_ancestor'))
              ORDER BY ABS(CONCEPT_DELTA) DESC, VOCABULARY_ID_1)
SELECT VOCABULARY_ID_1 AS VOCABULARY_ID,
       TO_CHAR(CAST(CONCEPT_DELTA AS FLOAT)) AS CONCEPT_DELTA
FROM VGSC
  UNION ALL
SELECT '-',
       TO_CHAR(SUM(CONCEPT_DELTA))
FROM VGSC;

SPOOL OFF
EXIT